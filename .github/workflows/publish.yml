name: ๐ AGRO_TECH Smart Publish

# ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ ุฅุฑุณุงู ุงูููุฏ ููุฑุน main
on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    # ุฑุจุท ุงูุนูู ุจุจูุฆุฉ ุงูุฅูุชุงุฌ ูู GitHub Secrets
    environment: production 
    
    steps:
      - name: ๐ฅ ุณุญุจ ุงูููุฏ ุงููุตุฏุฑู (Checkout)
        uses: actions/checkout@v4

      - name: ๐ ุชุณุฌูู ุงูุฏุฎูู ุฅูู GitHub Packages (GHCR)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ๐๏ธ ุจูุงุก ูุฑูุน ุตูุฑุฉ Docker (ุญูู ุงููุงุนุฏุฉ ุงููุงููุฉ)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          # ููุง ูุชู ุชูุฑูุฑ "ุงูููุงุชูุญ" ูู ุฎุฒูุฉ GitHub ุฅูู ูุญุฑู Docker ุฃุซูุงุก ุงูุจูุงุก
          build-args: |
            # 1. ุงูุฃูู ููุงุนุฏุฉ ุงูุจูุงูุงุช
            DJANGO_SECRET_KEY=${{ secrets.DJANGO_SECRET_KEY }}
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            
            # 2. ุงูุฃููุงุฑ ุงูุตูุงุนูุฉ ูุงูุฌุบุฑุงููุง
            SH_CLIENT_ID=${{ secrets.SH_CLIENT_ID }}
            SH_CLIENT_SECRET=${{ secrets.SH_CLIENT_SECRET }}
            SH_INSTANCE_ID=${{ secrets.SH_INSTANCE_ID }}
            GOOGLE_MAPS_API_KEY=${{ secrets.GOOGLE_MAPS_API_KEY }}
            FAO_API_KEY=${{ secrets.FAO_API_KEY }}
            
            # 3. ุงูุฐูุงุก ุงูุงุตุทูุงุนู (AI Engine)
            HF_TOKEN=${{ secrets.HF_TOKEN }}
            LANCEDB_URI=${{ secrets.LANCEDB_URI }}
            MODAL_TOKEN_ID=${{ secrets.MODAL_TOKEN_ID }}
            MODAL_TOKEN_SECRET=${{ secrets.MODAL_TOKEN_SECRET }}
            
            # 4. ุงูุชุฎุฒูู ูุงูุฃุฏุงุก (R2 & Redis)
            R2_ACCESS_KEY=${{ secrets.R2_ACCESS_KEY }}
            R2_SECRET_KEY=${{ secrets.R2_SECRET_KEY }}
            REDIS_URL=${{ secrets.REDIS_URL }}
            REDIS_TOKEN=${{ secrets.REDIS_TOKEN }}
            
            # 5. ุงูุชูุงุตู (Notifications & Video)
            FIREBASE_CONFIG_PATH=${{ secrets.FIREBASE_CONFIG_PATH }}
            MAILERSEND_API_KEY=${{ secrets.MAILERSEND_API_KEY }}
            JITSI_DOMAIN=${{ secrets.JITSI_DOMAIN }}
            
          # ูุณู ุงูุตูุฑุฉ ุจุฑูู ุงูุฅุตุฏุงุฑ (SHA) ูุจุงููุณู ุงูุฃุญุฏุซ (latest)
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}

      - name: โ ุชุฃููุฏ ุงูุงูุชูุงุก
        run: echo "ุชู ุจูุงุก ูุฑูุน ุตูุฑุฉ AGRO_TECH ุจูุฌุงุญ ุฅูู GitHub Packages!"